Imports System.Data
Imports ThanhTraLaoDongModel
Imports Cls_Common
Imports SecurityService
Partial Class Control_LuongToiThieu_List
    Inherits System.Web.UI.UserControl
    Private Shared ReadOnly log As log4net.ILog = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)
#Region "Sub and Function"
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            Dim script As ScriptManager = ScriptManager.GetCurrent(Me.Page)
            If Not script Is Nothing AndAlso script.IsInAsyncPostBack Then
                ScriptManager.RegisterStartupScript(Me.Page, Me.Page.GetType, "duyjs", "ajaxJquery()", True)
                ScriptManager.RegisterStartupScript(Me.Page, Me.Page.GetType, "duyjs1", "ajaxJqueryToolTip()", True)
            Else
                Me.Page.ClientScript.RegisterStartupScript(Me.Page.GetType(), "duyjs", String.Concat("Sys.Application.add_load(function(){", "ajaxJquery()", "});"), True)
                Me.Page.ClientScript.RegisterStartupScript(Me.Page.GetType(), "duyjs1", String.Concat("Sys.Application.add_load(function(){", "ajaxJqueryToolTip()", "});"), True)
            End If
            BindToGrid()
            btnDelete.Attributes.Add("onclick", "return confirmMultiDelete('" & btnDelete.ClientID & "');")
            'updatedate()
        End If
    End Sub
    Private Sub updatedate()
        Using data As New ThanhTraLaoDongEntities
            data.ExecuteStoreCommand("ALTER PROCEDURE [dbo].[usp_Rpt_TongHopViPhamLaoDong](	  	@SoQuyetDinh nvarchar(50),  	@MaTinh int,  	@LoaiNguoiDung int,  	@pr_ReportParams nvarchar(4000)  )  AS  BEGIN    	   	Create Table #Temp(  		ViPhamID nvarchar(10),  		Name nvarchar(1000),		  		Col0 bigint,  		SumVp bigint default 0  	)  	Declare  @indexColum int;  	set @indexColum = 0;  	     	declare @ID nvarchar(10);   	declare @Tite nvarchar(1000);   	declare @ChuoiDieuKien nvarchar(3000);   	DECLARE CursorViPhamID CURSOR FOR  		SELECT temp.sItem, chh.CauHoiVietTat, chh.ChuoiDieuKien  		FROM dbo.fnGetItems(@pr_ReportParams,N'#') temp LEFT JOIN CauHoiHierarchy chh on temp.sItem = chh.CauHoiId  				         	declare @MaDN int;   	declare @TenDN nvarchar(1000);   	declare @PhieuId int;      	DECLARE CursorDN CURSOR FOR  		SELECT DISTINCT dn.DoanhNghiepID, Dn.TenVietTat, pn.PhieuId  		FROM DoanhNghiep dn INNER JOIN PhieuNhapHeader pn on dn.DoanhNghiepID = pn.DoanhNghiepID  		WHERE	   				(dn.TinhID = @MaTinh or @MaTinh = 0) AND  				   				pn.LoaiPhieu = 1 AND   				   				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >= 12 AND  				   				([dbo].fn_GetSoQuyetDinh(pn.SoQuyenDinh) like '%' + @SoQuyetDinh +  '%') AND  				   				(  					   					(@LoaiNguoiDung=1 and   					pn.NguoiTao in (  							select UserName   							from users   							where UserId in (  												select  UserId  												from UsersTinh   												group by UserId  												having COUNT(TinhId)=(select COUNT(*) from Tinh)  											)   							)  					) OR  					 														  					(@LoaiNguoiDung=2 and   					pn.NguoiTao in (  							select UserName   							from users   							where UserId in (  												select  UserId  												from UsersTinh   												group by UserId  												having COUNT(TinhId)<(select COUNT(*) from Tinh)  											)   							)   					)OR @LoaiNguoiDung=0																							  								  				)  				  	 		  	OPEN CursorDN  		FETCH NEXT FROM CursorDN into @MaDN,@TenDN, @PhieuId  		WHILE @@FETCH_STATUS = 0  			BEGIN  				   				declare @sqlExec nvarchar(4000);  				   				Declare @VaribleItem bigint;  				set @VaribleItem=0;  				   				   				IF @indexColum != 0   					BEGIN 					  						set @sqlExec ='ALTER TABLE #Temp ADD Col'+ CAST((@indexColum ) as nvarchar(10))+ ' bigint ';  						exec (@sqlExec)  					END  										  				   				OPEN CursorViPhamID  					FETCH NEXT FROM CursorViPhamID into @ID,@Tite,@ChuoiDieuKien  					WHILE @@FETCH_STATUS = 0  						BEGIN  							   							SET @VaribleItem = 0;    							If Len(@ChuoiDieuKien) > 0  							BEGIN  								declare @query nvarchar(1000)  								set @query = @ChuoiDieuKien + ' in(	select pn.PhieuId   																	from PhieuNhapHeader pn 																			  																	WHERE	pn.DoanhNghiepID = ' + CAST(@MaDN AS nvarchar(50)) + ' AND   																			pn.LoaiPhieu = 1 AND   																			pn.PhieuId = ' + cast(@PhieuId as nvarchar(50)) + ' and  																			(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,'';'')) >= 12 )'  								   								CREATE TABLE #resultat  								 (resultat bigint)  								   								INSERT INTO #resultat exec sp_executesql @query    								SELECT @VaribleItem = resultat FROM #resultat  								DROP TABLE #resultat  							END				  							  							IF @indexColum = 0   							BEGIN							  								INSERT INTO #Temp(ViPhamID, Name, Col0) VALUES( @ID, @Tite , @VaribleItem)  								   								SET @sqlExec ='';  								 									  								set @sqlExec = 'UPDATE #Temp SET SumVp = SumVp + ' + cast(@VaribleItem as nvarchar(50))  												+ ' WHERE ViPhamID =''' + @ID +'''';  								exec (@sqlExec)  							END									  							ELSE  								BEGIN   									   									SET @sqlExec ='';  									 									  									set @sqlExec = 'UPDATE #Temp SET Col' + CAST((@indexColum ) as nvarchar(10)) + '=' + CAST(@VaribleItem as nvarchar(30))  													+ ', SumVp = SumVp + ' + cast(@VaribleItem as nvarchar(50)) + ' WHERE ViPhamID =''' + @ID +'''';  									exec (@sqlExec)  								END  							  							FETCH NEXT FROM CursorViPhamID into @ID,@Tite,@ChuoiDieuKien  						END  					CLOSE CursorViPhamID  					 				  					  				FETCH NEXT FROM CursorDN into @MaDN,@TenDN, @PhieuId  				   				Set @indexColum = @indexColum +1;  			END  	CLOSE CursorDN  	DEALLOCATE CursorDN  DEALLOCATE CursorViPhamID	     SELECT DISTINCT dn.DoanhNghiepID, Dn.TenVietTat, pn.PhieuID  FROM DoanhNghiep dn INNER JOIN PhieuNhapHeader pn on dn.DoanhNghiepID = pn.DoanhNghiepID  WHERE	   		(dn.TinhID = @MaTinh or @MaTinh = 0) AND  		   		pn.LoaiPhieu = 1 AND   		   		(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >= 12 AND  		   		([dbo].fn_GetSoQuyetDinh(pn.SoQuyenDinh) like '%' + @SoQuyetDinh +  '%' ) AND  		   		(  			   			(@LoaiNguoiDung=1 and   			pn.NguoiTao in (  					select UserName   					from users   					where UserId in (  										select  UserId  										from UsersTinh   										group by UserId  										having COUNT(TinhId)=(select COUNT(*) from Tinh)  									)   					)  			) OR  			 														  			(@LoaiNguoiDung=2 and   			pn.NguoiTao in (  					select UserName   					from users   					where UserId in (  										select  UserId  										from UsersTinh   										group by UserId  										having COUNT(TinhId)<(select COUNT(*) from Tinh)  									)   					)   			)OR @LoaiNguoiDung=0																							  						  		)    		  SELECT * FROM #Temp       DROP TABLE 	#Temp    END    ")
            data.ExecuteStoreCommand("ALTER proc [dbo].[uspChiSoThongKeLaoDongTheoTinhNam]  (  @Nam int,  @Tinh nvarchar(3000)  )  as  begin  	   	with DNBBTTTrongHeThong as   	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNBBTTTrongHeThong   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu=1 and   				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTTrongHeThong as  	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNPTKTTrongHeThong   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where   pn.LoaiPhieu=0 and   				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTTrongKy as   	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNBBTTTrongKy   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu=1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTTrongKy as  	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNPTKTTrongKy   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where   pn.LoaiPhieu=0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ31 as  	(  		select count(distinct pn.DoanhNghiepId) SUMDNBBTTQ31  		from CauHoi3 q3 inner join PhieuNhapHeader pn on q3.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q3.q31,0)>0 and  				pn.LoaiPhieu=1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ31 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNPTKTQ31  		from CauHoi3 q3 inner join PhieuNhapHeader pn on q3.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q3.q31,0)>0 and  				pn.LoaiPhieu=0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNBBTTCD as	   	(  		select count(distinct pn.DoanhNghiepId) SUMDNBBTTCD  		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	dn.IsCongDoan=1 and  				pn.LoaiPhieu=1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),	  	DNPTKTCD as	   	(  		select count(distinct pn.DoanhNghiepId) SUMDNPTKTCD  		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	dn.IsCongDoan=1 and  				pn.LoaiPhieu=0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ81 as	  	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNBBTTQ81  		from CauHoi8 q8 inner join PhieuNhapHeader pn on q8.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	q8.Q81 = 1 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ81 as	  	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNPTKTQ81  		from CauHoi8 q8 inner join PhieuNhapHeader pn on q8.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	q8.Q81 = 1 and  				pn.LoaiPhieu=0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTLD10 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNBBTTLD10  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	ISNULL(q2.Q218,0) > 10 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTLD10 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNPTKTLD10  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	ISNULL(q2.Q218,0) > 10 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ45 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNBBTTQ45  		from CauHoi4 q4 inner join PhieuNhapHeader pn on q4.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	(q4.Q45 = 1 or dn.DoanhNghiepId =2) and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ45 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNPTKTQ45  		from CauHoi4 q4 inner join PhieuNhapHeader pn on q4.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	(q4.Q45 = 1 or dn.DoanhNghiepId =2) and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTCoBaoCao as   	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNBBTTCoBaoCao   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.IsThucHieKienNghi = 1 and  				pn.LoaiPhieu=1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTCoBaoCao as  	(  		select COUNT(distinct pn.DoanhNghiepId) SUMDNPTKTCoBaoCao   		from PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where   pn.IsThucHieKienNghi = 1 and  				pn.LoaiPhieu=0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTQ12 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNBBTTQ12  		from CauHoi1 q1 inner join PhieuNhapHeader pn on q1.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	q1.Q12 = 1 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ12 as	  	(  		select count(distinct pn.DoanhNghiepId) SUMDNPTKTQ12  		from CauHoi1 q1 inner join PhieuNhapHeader pn on q1.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	q1.Q12 = 1 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ4112 as	  	(  		select isnull(SUM(q4.Q4112),0) SUMDNBBTTQ4112  		from CauHoi4 q4 inner join PhieuNhapHeader pn on q4.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q4.Q4112,0) > 0 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ4112 as	  	(  		select isnull(SUM(q4.Q4112),0) SUMDNPTKTQ4112  		from CauHoi4 q4 inner join PhieuNhapHeader pn on q4.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q4.Q4112,0) > 0 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ218 as	  	(  		select sum(q2.Q218) SUMDNBBTTQ218  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	ISNULL(q2.Q218,0) > 0 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ218 as	  	(  		select sum(q2.Q218) SUMDNPTKTQ218  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	ISNULL(q2.Q218,0) > 0 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ234 as	  	(  		select isnull(SUM(q2.Q234),0) SUMDNBBTTQ234  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q2.Q234,0) > 0 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ234 as	  	(  		select isnull(SUM(q2.Q234),0) SUMDNPTKTQ234  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q2.Q234,0) > 0 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTQ235 as   	(  		select	isnull(SUM(isnull(q2.Q235,0)),0) SUMDNBBTTQ235,															   				(isnull(SUM(isnull(q2.Q235,0)),0) - ISNULL(Sum(ISNULL(q2.Q251,0)),0)) DNBBTTLDMoiTuyenTruLDThoiViec,	   				ISNULL(Sum(ISNULL(q2.Q251,0)),0) SUMDNBBTTLDThoiViec													   		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ235 as   	(  		select	isnull(SUM(isnull(q2.Q235,0)),0) SUMDNPTKTQ235,															   				(isnull(SUM(isnull(q2.Q235,0)),0) - ISNULL(Sum(ISNULL(q2.Q251,0)),0)) DNPTKTLDMoiTuyenTruLDThoiViec,	   				ISNULL(Sum(ISNULL(q2.Q251,0)),0) SUMDNPTKTLDThoiViec													   		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTQ238 as	  	(  		select isnull(SUM(q2.Q238),0) SUMDNBBTTQ238  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q2.Q238,0) > 0 and  				pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ238 as	  	(  		select isnull(SUM(q2.Q238),0) SUMDNPTKTQ238  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	isnull(q2.Q238,0) > 0 and  				pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTQ217 as	  	(  		select sum(ISNULL(q2.Q217,0)) SUMDNBBTTQ217, SUM(ISNULL(q2.Q218,0) - ISNULL(q2.Q2110,0)) SUMDNBBTTQ218_Q2110  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ217 as	  	(  		select sum(ISNULL(q2.Q217,0)) SUMDNPTKTQ217, SUM(ISNULL(q2.Q218,0) - ISNULL(q2.Q2110,0)) SUMDNPTKTQ218_Q2110  		from CauHoi2 q2 inner join PhieuNhapHeader pn on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTSoNguoiLamNgheNguyHiem as    	(  		select	sum(isnull(BC.SoNguoiLamNgheNguyHiem,0)) SUMDNBBTTSoNguoiLamNgheNguyHiem	  		from  		(  			select distinct pn.DoanhNghiepId, pn.SoNguoiLamNgheNguyHiem  			from	PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  			where	pn.LoaiPhieu = 1 and   					(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  					(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  				  		) BC  	),  	DNPTKTSoNguoiLamNgheNguyHiem as	   	(  		select	sum(isnull(BC.SoNguoiLamNgheNguyHiem,0)) SUMDNPTKTSoNguoiLamNgheNguyHiem	  		from  		(  			select distinct pn.DoanhNghiepId, pn.SoNguoiLamNgheNguyHiem  			from	PhieuNhapHeader pn inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  			where	pn.LoaiPhieu = 0 and   					(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  					(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  				  		) BC  	),  	   	DNBBTTQ706222 as	  	(  		select	isnull(SUM(isnull(q2.Q218,0) - isnull(q7.Q706222,0)),0) SUMDNBBTTQ706222  		from CauHoi7 q7 inner join PhieuNhapHeader pn on q7.PhieuId=pn.PhieuID  						inner join CauHoi2 q2 on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ706222 as	  	(  		select	isnull(SUM(isnull(q2.Q218,0) - isnull(q7.Q706222,0)),0) SUMDNPTKTQ706222  		from CauHoi7 q7 inner join PhieuNhapHeader pn on q7.PhieuId=pn.PhieuID  						inner join CauHoi2 q2 on q2.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	   	DNBBTTQ7051 as	  	(  		select	isnull(SUM(isnull(q7.Q7051,0)),0) SUMDNBBTTQ7051,		   				isnull(SUM(isnull(q7.Q711,0)),0) SUMDNBBTTQ711,			   				isnull(SUM(isnull(q7.Q7118,0)),0) SUMDNBBTTQ7118,		   				isnull(SUM(isnull(q7.Q7111,0)),0) SUMDNBBTTQ7111		   		from CauHoi7 q7 inner join PhieuNhapHeader pn on q7.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ7051 as	  	(  		select	isnull(SUM(isnull(q7.Q7051,0)),0) SUMDNPTKTQ7051,		   				isnull(SUM(isnull(q7.Q711,0)),0) SUMDNPTKTQ711,			   				isnull(SUM(isnull(q7.Q7118,0)),0) SUMDNPTKTQ7118,		   				isnull(SUM(isnull(q7.Q7111,0)),0) SUMDNPTKTQ7111		   		from CauHoi7 q7 inner join PhieuNhapHeader pn on q7.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTQ922 as	  	(  		select	isnull(SUM(isnull(q9.Q922,0)),0) SUMDNBBTTQ922,			   				isnull(SUM(isnull(q9.Q925,0)),0) SUMDNBBTTQ925			    		from CauHoi9 q9 inner join PhieuNhapHeader pn on q9.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTQ922 as	  	(  		select	isnull(SUM(isnull(q9.Q922,0)),0) SUMDNPTKTQ922,			   				isnull(SUM(isnull(q9.Q925,0)),0) SUMDNPTKTQ925			   		from CauHoi9 q9 inner join PhieuNhapHeader pn on q9.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),   	   	DNBBTTCauHoi6 as	  	(  		select	isnull(SUM(isnull(q6.Q611,0)),0) SUMDNBBTT_LDPhaiTGBHXH,   				isnull(SUM(isnull(q6.Q611 - q6.Q612,0)),0) SUMDNBBTT_LDChuaTGBHXH,  				isnull(SUM(isnull(q6.Q621,0)),0) SUMDNBBTT_LDPhaiTGBHTN,   				isnull(SUM(isnull(q6.Q621 - q6.Q622,0)),0) SUMDNBBTT_LDChuaTGBHTN,   				SUM(case when isnull(q6.Q641,0) = 0 then 0 else 1 end) SUMDNBBTT_DNNoBHXH,  				isnull(SUM(isnull(q6.Q641,0)),0) SUMDNBBTT_TienNoBHXH,			    				isnull(SUM(isnull(q6.Q65,0)),0) SUMDNBBTT_TienChiemDung  		from CauHoi6 q6 inner join PhieuNhapHeader pn on q6.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 1 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	),  	DNPTKTCauHoi6 as	  	(  		select	isnull(SUM(isnull(q6.Q611,0)),0) SUMDNPTKT_LDPhaiTGBHXH,   				isnull(SUM(isnull(q6.Q612,0)),0) SUMDNPTKT_LDChuaTGBHXH,  				isnull(SUM(isnull(q6.Q621,0)),0) SUMDNPTKT_LDPhaiTGBHTN,   				isnull(SUM(isnull(q6.Q622,0)),0) SUMDNPTKT_LDChuaTGBHTN,   				SUM(case when isnull(q6.Q641,0) = 0 then 0 else 1 end) SUMDNPTKT_DNNoBHXH,  				isnull(SUM(isnull(q6.Q641,0)),0) SUMDNPTKT_TienNoBHXH,			    				isnull(SUM(isnull(q6.Q65,0)),0) SUMDNPTKT_TienChiemDung  		from CauHoi6 q6 inner join PhieuNhapHeader pn on q6.PhieuId=pn.PhieuID  						inner join DoanhNghiep dn on pn.DoanhNghiepId=dn.DoanhNghiepId  		where	pn.LoaiPhieu = 0 and   				(YEAR(pn.NgayKetThucPhieu)=@Nam or @Nam=0) and  				(exists(select * from dbo.fnGetItems(@Tinh,'#') where sItem=dn.TinhId) or @Tinh='') and  				(SELECT COUNT(*) FROM dbo.fnGetItems(pn.CauHoiDaTraLoi,';')) >=12  	)  	  	   	select	1 Stt,   			N'Tổng số doanh nghiệp' TieuChi,   			A.SUMDNBBTTTrongHeThong BienBan,   			B.SUMDNPTKTTrongHeThong Phieu,   			(A.SUMDNBBTTTrongHeThong + B.SUMDNPTKTTrongHeThong) Chung   	from DNBBTTTrongHeThong A,DNPTKTTrongHeThong B  	union		  	select	2 Stt,  			N'Tỷ lệ DN thỏa ước LĐTT' TieuChi,   			case when C.SUMDNBBTTCD >0 then cast((1.*A.SUMDNBBTTQ31 / C.SUMDNBBTTCD) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTCD >0 then cast((1.*B.SUMDNPTKTQ31 / D.SUMDNPTKTCD) * 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTCD + D.SUMDNPTKTCD) >0 then cast((1.*(A.SUMDNBBTTQ31 + B.SUMDNPTKTQ31) / (C.SUMDNBBTTCD + D.SUMDNPTKTCD)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTQ31 A, DNPTKTQ31 B, DNBBTTCD C, DNPTKTCD D  	union		  	select	3 Stt,   			N'Tỷ lệ DN có nội quy LĐ' TieuChi,   			case when C.SUMDNBBTTLD10 >0 then cast((1.*A.SUMDNBBTTQ81 / C.SUMDNBBTTLD10) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTLD10 >0 then cast((1.*B.SUMDNPTKTQ81 / D.SUMDNPTKTLD10)* 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTLD10 + D.SUMDNPTKTLD10) >0 then cast((1.*(A.SUMDNBBTTQ81 + B.SUMDNPTKTQ81) / (C.SUMDNBBTTLD10 + D.SUMDNPTKTLD10)) * 100 as decimal(5,2)) else 0 end Chung   	 from DNBBTTQ81 A, DNPTKTQ81 B, DNBBTTLD10 C, DNPTKTLD10 D  	union		  	select	4 Stt,   			N'Tỷ lệ doanh nghiệp có thang, bảng lương' TieuChi,   			case when C.SUMDNBBTTLD10 >0 then cast((1.*A.SUMDNBBTTQ45 / C.SUMDNBBTTLD10) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTLD10 >0 then cast((1.*B.SUMDNPTKTQ45 / D.SUMDNPTKTLD10)* 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTLD10 + D.SUMDNPTKTLD10) >0 then cast((1.*(A.SUMDNBBTTQ45 + B.SUMDNPTKTQ45) / (C.SUMDNBBTTLD10 + D.SUMDNPTKTLD10)) * 100 as decimal(5,2)) else 0 end Chung   	 from DNBBTTQ45 A, DNPTKTQ45 B, DNBBTTLD10 C, DNPTKTLD10 D  	union		  	select	5 Stt,  			N'Tỷ lệ doanh nghiệp có báo cáo về lao động' TieuChi,   			case when C.SUMDNBBTTTrongKy >0 then cast((1.*A.SUMDNBBTTCoBaoCao / C.SUMDNBBTTTrongKy) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTTrongKy >0 then cast((1.*B.SUMDNPTKTCoBaoCao / D.SUMDNPTKTTrongKy)* 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy) >0 then cast((1.*(A.SUMDNBBTTCoBaoCao + B.SUMDNPTKTCoBaoCao) / (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTCoBaoCao A, DNPTKTCoBaoCao B, DNBBTTTrongKy C, DNPTKTTrongKy D  	union	  	select	6 Stt,  			N'Tỷ lệ doanh nghiệp có báo cáo về ATVSLĐ' TieuChi,   			case when C.SUMDNBBTTTrongKy >0 then cast((1.*A.SUMDNBBTTQ12 / C.SUMDNBBTTTrongKy) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTTrongKy >0 then cast((1.*B.SUMDNPTKTQ12 / D.SUMDNPTKTTrongKy)* 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy) >0 then cast((1.*(A.SUMDNBBTTQ12 + B.SUMDNPTKTQ12) / (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTQ12 A, DNPTKTQ12 B, DNBBTTTrongKy C, DNPTKTTrongKy D  	union	  	select	7 Stt,  			N'Tiền lương bình quân tháng(đồng)' TieuChi,   			case when C.SUMDNBBTTTrongKy >0 then cast((1.*A.SUMDNBBTTQ4112 / C.SUMDNBBTTTrongKy) as decimal(12,0)) else 0 end  BienBan,   			case when D.SUMDNPTKTTrongKy >0 then cast((1.*B.SUMDNPTKTQ4112 / D.SUMDNPTKTTrongKy) as decimal(12,0)) else 0 end Phieu,   			case when (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy) >0 then cast((1.*(A.SUMDNBBTTQ4112 + B.SUMDNPTKTQ4112) / (C.SUMDNBBTTTrongKy + D.SUMDNPTKTTrongKy)) as decimal(12,0)) else 0 end Chung   	from DNBBTTQ4112 A, DNPTKTQ4112 B, DNBBTTTrongKy C, DNPTKTTrongKy D  	union  	select	8 Stt,   			N'Tổng số lao động' TieuChi,   			A.SUMDNBBTTQ218 BienBan,   			B.SUMDNPTKTQ218 Phieu,   			(A.SUMDNBBTTQ218 + B.SUMDNPTKTQ218) Chung   	from DNBBTTQ218 A,DNPTKTQ218 B  	union  	select	9 Stt,   			N'Nhu cầu tuyển lao động (người)' TieuChi,   			A.SUMDNBBTTQ234 BienBan,   			B.SUMDNPTKTQ234 Phieu,   			(A.SUMDNBBTTQ234 + B.SUMDNPTKTQ234) Chung   	from DNBBTTQ234 A,DNPTKTQ234 B  	union  	select	10 Stt,   			N'Số lao động được tuyển dụng' TieuChi,   			A.SUMDNBBTTQ235 BienBan,   			B.SUMDNPTKTQ235 Phieu,   			(A.SUMDNBBTTQ235 + B.SUMDNPTKTQ235) Chung   	from DNBBTTQ235 A,DNPTKTQ235 B  	union		  	select	11 Stt,   			N'Tỷ lệ lao động tuyển qua Trung tâm GTVL' TieuChi,   			case when C.SUMDNBBTTQ235 >0 then cast((1.*A.SUMDNBBTTQ238 / C.SUMDNBBTTQ235) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTQ235 >0 then cast((1.*B.SUMDNPTKTQ238 / D.SUMDNPTKTQ235) * 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTQ235 + D.SUMDNPTKTQ235) >0 then cast((1.*(A.SUMDNBBTTQ238 + B.SUMDNPTKTQ238) / (C.SUMDNBBTTQ235 + D.SUMDNPTKTQ235)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTQ238 A, DNPTKTQ238 B, DNBBTTQ235 C, DNPTKTQ235 D  	union		  	select	12 Stt,   			N'Tỷ lệ tăng trưởng việc làm' TieuChi,   			case when C.SUMDNBBTTQ218 >0 then cast((1.*A.DNBBTTLDMoiTuyenTruLDThoiViec / C.SUMDNBBTTQ218) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when D.SUMDNPTKTQ218 >0 then cast((1.*B.DNPTKTLDMoiTuyenTruLDThoiViec / D.SUMDNPTKTQ218) * 100 as decimal(5,2)) else 0 end Phieu,   			case when (C.SUMDNBBTTQ218 + D.SUMDNPTKTQ218) >0 then cast((1.*(A.DNBBTTLDMoiTuyenTruLDThoiViec + B.DNPTKTLDMoiTuyenTruLDThoiViec) / (C.SUMDNBBTTQ218 + D.SUMDNPTKTQ218)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTQ235 A, DNPTKTQ235 B, DNBBTTQ218 C, DNPTKTQ218 D  	union  	select	13 Stt,   			N'Tỷ lệ chưa ký hợp đồng LĐ' TieuChi,   			case when A.SUMDNBBTTQ218_Q2110 >0 then cast((1.*A.SUMDNBBTTQ217 / A.SUMDNBBTTQ218_Q2110) * 100 as decimal(5,2)) else 0 end  BienBan,   			case when B.SUMDNPTKTQ218_Q2110 > 0 then cast((1.*B.SUMDNPTKTQ217 / B.SUMDNPTKTQ218_Q2110) * 100 as decimal(5,2)) else 0 end Phieu,   			case when (A.SUMDNBBTTQ218_Q2110 + B.SUMDNPTKTQ218_Q2110) >0 then cast((1.*(A.SUMDNBBTTQ217 + B.SUMDNPTKTQ217) / (A.SUMDNBBTTQ218_Q2110 + B.SUMDNPTKTQ218_Q2110)) * 100 as decimal(5,2)) else 0 end Chung   	from DNBBTTQ217 A, DNPTKTQ217 B   	union  	select	14 Stt,   			N'Số lao động thôi việc' TieuChi,   			A.SUMDNBBTTLDThoiViec BienBan,   			B.SUMDNPTKTLDThoiViec Phieu,   			(A.SUMDNBBTTLDThoiViec + B.SUMDNPTKTLDThoiViec) Chung   	from DNBBTTQ235 A,DNPTKTQ235 B  	union  	select	15 Stt,   			N'Số lao động phải làm việc trong điều kiện nặng nhọc, độc hại' TieuChi,   			A.SUMDNBBTTSoNguoiLamNgheNguyHiem BienBan,   			B.SUMDNPTKTSoNguoiLamNgheNguyHiem Phieu,   			(A.SUMDNBBTTSoNguoiLamNgheNguyHiem + B.SUMDNPTKTSoNguoiLamNgheNguyHiem) Chung  	from DNBBTTSoNguoiLamNgheNguyHiem A,DNPTKTSoNguoiLamNgheNguyHiem B  	union  	select	16 Stt,   			N'Số người được tập huấn ATVSLĐ định kì' TieuChi,   			A.SUMDNBBTTQ706222 BienBan,   			B.SUMDNPTKTQ706222 Phieu,   			(A.SUMDNBBTTQ706222 + B.SUMDNPTKTQ706222) Chung  	from DNBBTTQ706222 A,DNPTKTQ706222 B  	union  	select	17 Stt,   			N'Số thiết bị có yêu cầu nghiêm ngặt về an toàn lao động được kiểm tra' TieuChi,   			A.SUMDNBBTTQ7051 BienBan,   			B.SUMDNPTKTQ7051 Phieu,   			(A.SUMDNBBTTQ7051 + B.SUMDNPTKTQ7051) Chung  	 from DNBBTTQ7051 A,DNPTKTQ7051 B  	union  	select	18 Stt,   			N'Số vụ tai nạn lao động' TieuChi,   			A.SUMDNBBTTQ711 BienBan,   			B.SUMDNPTKTQ711 Phieu,   			(A.SUMDNBBTTQ711 + B.SUMDNPTKTQ711) Chung  	 from DNBBTTQ7051 A,DNPTKTQ7051 B  	union  	select	19 Stt,   			N'Số người bị tai nạn lao động' TieuChi,   			A.SUMDNBBTTQ7118 BienBan,   			B.SUMDNPTKTQ7118 Phieu,   			(A.SUMDNBBTTQ7118 + B.SUMDNPTKTQ7118) Chung  	 from DNBBTTQ7051 A,DNPTKTQ7051 B  	union  	select	20 Stt,   			N'Số người bị chết do tai nạn lao động' TieuChi,   			A.SUMDNBBTTQ7111 BienBan,   			B.SUMDNPTKTQ7111 Phieu,   			(A.SUMDNBBTTQ7111 + B.SUMDNPTKTQ7111) Chung  	 from DNBBTTQ7051 A,DNPTKTQ7051 B  	union  	select	21 Stt,   			N'Số vụ đình công' TieuChi,  			A.SUMDNBBTTQ922 BienBan,   			B.SUMDNPTKTQ922 Phieu,   			(A.SUMDNBBTTQ922 + B.SUMDNPTKTQ922) Chung   	from DNBBTTQ922 A,DNPTKTQ922 B  	union  	select	22 Stt,   			N'Số người tham gia đình công' TieuChi,   			A.SUMDNBBTTQ925 BienBan,   			B.SUMDNPTKTQ925 Phieu,   			(A.SUMDNBBTTQ925 + B.SUMDNPTKTQ925) Chung  	from DNBBTTQ922 A,DNPTKTQ922 B  	union  	select	23 Stt,   			N'Tổng Số lao động phải tham gia bảo hiểm xã hội bắt buộc' TieuChi,   			A.SUMDNBBTT_LDPhaiTGBHXH BienBan,   			B.SUMDNPTKT_LDPhaiTGBHXH Phieu,   			(A.SUMDNBBTT_LDPhaiTGBHXH + B.SUMDNPTKT_LDPhaiTGBHXH) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	24 Stt,   			N'Tổng Số lao động chưa tham gia bảo hiểm xã hội' TieuChi,   			A.SUMDNBBTT_LDChuaTGBHXH BienBan,   			B.SUMDNPTKT_LDChuaTGBHXH Phieu,   			(A.SUMDNBBTT_LDChuaTGBHXH + B.SUMDNPTKT_LDChuaTGBHXH) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	25 Stt,   			N'Tổng Số lao động phải tham gia bảo hiểm thất nghiệp' TieuChi,   			A.SUMDNBBTT_LDPhaiTGBHTN BienBan,   			B.SUMDNPTKT_LDPhaiTGBHTN Phieu,   			(A.SUMDNBBTT_LDPhaiTGBHTN + B.SUMDNPTKT_LDPhaiTGBHTN) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	26 Stt,   			N'Tổng Số lao động chưa tham gia bảo hiểm thất nghiệp' TieuChi,   			A.SUMDNBBTT_LDChuaTGBHTN BienBan,   			B.SUMDNPTKT_LDChuaTGBHTN Phieu,   			(A.SUMDNBBTT_LDChuaTGBHTN + B.SUMDNPTKT_LDChuaTGBHTN) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	27 Stt,   			N'Tổng Số doanh nghiệp nợ bảo hiểm xã hội' TieuChi,   			A.SUMDNBBTT_DNNoBHXH BienBan,   			B.SUMDNPTKT_DNNoBHXH Phieu,   			(A.SUMDNBBTT_DNNoBHXH + B.SUMDNPTKT_DNNoBHXH) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	28 Stt,   			N'Tổng Số tiền nợ bảo hiểm xã hội(triệu đồng)' TieuChi,   			A.SUMDNBBTT_TienNoBHXH BienBan,   			B.SUMDNPTKT_TienNoBHXH Phieu,   			(A.SUMDNBBTT_TienNoBHXH + B.SUMDNPTKT_TienNoBHXH) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	union  	select	29 Stt,   			N'Số tiền đóng BHXH chiếm dụng của người lao động(triệu đồng)' TieuChi,   			A.SUMDNBBTT_TienChiemDung BienBan,   			B.SUMDNPTKT_TienChiemDung Phieu,   			(A.SUMDNBBTT_TienChiemDung + B.SUMDNPTKT_TienChiemDung) Chung  	from DNBBTTCauHoi6 A,DNPTKTCauHoi6 B  	  end")
        End Using

    End Sub
    Private Sub BindToGrid(Optional ByVal iPage As Integer = 1, Optional ByVal strSearch As String = "")
        Using data As New ThanhTraLaoDongEntities
            Dim arrSearch() As String = {iPage.ToString, strSearch}
            ViewState("search") = arrSearch
            'So ban ghi muon the hien tren trang
            Dim intPag_Size As Int32 = drpPage_Size.SelectedValue
            Dim p = (From q In data.LuongToiThieux Where q.TieuDe.Contains(strSearch) Order By q.LuongToiThieuID Descending Select q).Skip((iPage - 1) * intPag_Size).Take(intPag_Size).ToList
            Dim hv = (From q In data.LuongToiThieux Select q).ToList
            Dim strKey_Name() As String = {"LuongToiThieuID", "MucLuongToiThieu", "TieuDe", "IsNhaNuoc", "QuyetDinh", "NgayQuyetDinh"}
            'Tong so ban ghi
            If p.Count > 0 Then
                hidCount.Value = hv.Count
                Create_Pager(hidCount.Value, iPage, intPag_Size, 10)
            Else
                hidCount.Value = 0
                With rptPage
                    .DataSource = Nothing
                    .DataBind()
                End With
            End If
            With grdShow
                .DataKeyNames = strKey_Name
                .DataSource = p
                .DataBind()
            End With
            If (hidCount.Value > 0) Then
                lblTotal.Text = "Hiển thị " + (((iPage - 1) * intPag_Size) + 1).ToString("#,#") + " đến " + (((iPage - 1) * intPag_Size) + grdShow.Rows.Count).ToString("#,#") + " trong tổng số " + CInt(hidCount.Value).ToString("#,#") + " bản ghi."
            Else
                lblTotal.Text = ""
            End If
        End Using
    End Sub
    Sub Create_Pager(ByVal Total_Record As Integer, ByVal Page_Index As Integer, ByVal Page_Size As Integer, ByVal Page2Show As Integer)
        Dim TotalPage As Integer = IIf((Total_Record Mod Page_Size) = 0, Total_Record / Page_Size, Total_Record \ Page_Size + 1)
        'lu lai tong so ban ghi
        hidIndex_page.Value = TotalPage
        'gan lai curPage de set active
        hidCur_Page.Value = Page_Index
        'generate ra left page
        Dim cPageGenerate_left As IEnumerable(Of Integer)
        If Page_Index <= Page2Show Then
            cPageGenerate_left = Enumerable.Range(1, Page_Index)
        Else
            cPageGenerate_left = Enumerable.Range(Page_Index - Page2Show, Page2Show)
        End If
        'generate ra right page
        Dim cPageGenerate_Right As IEnumerable(Of Integer)
        If Page_Index + Page2Show <= TotalPage Then
            cPageGenerate_Right = Enumerable.Range(Page_Index, Page2Show + 1)
        Else
            cPageGenerate_Right = Enumerable.Range(Page_Index, TotalPage - Page_Index + 1)
        End If
        'union 2 range va bind to Grid
        With rptPage
            .DataSource = cPageGenerate_left.Union(cPageGenerate_Right)
            .DataBind()
        End With
    End Sub
    Protected Sub rptPage_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rptPage.ItemDataBound
        Dim lnkTitle As LinkButton
        lnkTitle = e.Item.FindControl("lnkTitle")
        Dim ScriptManager As System.Web.UI.ScriptManager = System.Web.UI.ScriptManager.GetCurrent(Me.Page)
        ScriptManager.RegisterAsyncPostBackControl(lnkTitle)
        If e.Item.DataItem = hidCur_Page.Value Then
            lnkTitle.Text = "<span class='current'>" & e.Item.DataItem & "</span>"
        Else
            lnkTitle.Text = "<span>" & e.Item.DataItem & "</span>"
        End If
        lnkTitle.ToolTip = e.Item.DataItem
    End Sub
    Protected Sub lnkTitle_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim lnkTile As LinkButton = CType(sender, LinkButton)
        Dim arrSearch() As String
        arrSearch = ViewState("search")
        BindToGrid(lnkTile.ToolTip, arrSearch(1))

        lnkLast.Enabled = True
        lnkFirst.Enabled = True
        If CInt(lnkTile.ToolTip) = hidIndex_page.Value Then
            lnkLast.Enabled = False
        ElseIf CInt(lnkTile.ToolTip) = 1 Then
            lnkFirst.Enabled = False
        End If
    End Sub
    Protected Sub lnkFirst_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lnkFirst.Click
        If hidCur_Page.Value > 1 Then
            hidCur_Page.Value = hidCur_Page.Value - 1
        End If
        Dim arrSearch() As String
        arrSearch = ViewState("search")
        BindToGrid(hidCur_Page.Value, arrSearch(1))
    End Sub
    Protected Sub lnkLast_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lnkLast.Click
        hidCur_Page.Value = hidCur_Page.Value + 1
        Dim arrSearch() As String
        arrSearch = ViewState("search")
        BindToGrid(hidCur_Page.Value, arrSearch(1))
    End Sub
#End Region
#Region "Event for control"

    Protected Sub lnkbtnDelete_Click(ByVal sender As Object, ByVal e As EventArgs)
        Dim intId As Integer
        Dim strLogName As String = ""
        Using data As New ThanhTraLaoDongEntities
            intId = grdShow.DataKeys(hidID.Value)("LuongToiThieuID").ToString
            Dim q = (From p In data.LuongToiThieux Where p.LuongToiThieuID = intId Select p).FirstOrDefault
            Try
                Dim huyen = (From a In data.Huyens Where a.LuongToiThieuID = intId).ToList
                If huyen.Count = 0 Then
                    data.LuongToiThieux.DeleteObject(q)
                    data.SaveChanges()
                    Excute_Javascript("Alertbox('Xóa dữ liệu thành công.');", Me.Page, True)
                Else
                    Excute_Javascript("Alertbox('Xóa thất bại. Lương tối thiểu này hiện tại có huyện tham chiếu đến.');", Me.Page, True)
                End If
            Catch ex As Exception
                log4net.Config.XmlConfigurator.Configure()
                log.Error("Error error " & AddTabSpace(1) & Session("Username") & AddTabSpace(1) & "IP:" & GetIPAddress(), ex)
                Excute_Javascript("Alertbox('Xóa thất bại (" & ex.Message & ").');", Me.Page, True)
            End Try
        End Using
        BindToGrid()
    End Sub
    Protected Sub btnDelete_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnDelete.Click
        Dim intId As Integer = 0
        Dim intCount As Integer
        Dim intTotal As Integer
        Dim strLTT = ""
        Using data As New ThanhTraLaoDongEntities
            Try
                For Each item As GridViewRow In grdShow.Rows
                    Dim chkItem As New CheckBox
                    chkItem = CType(item.FindControl("chkItem"), CheckBox)
                    If chkItem.Checked Then
                        intTotal += 1
                        intId = grdShow.DataKeys(item.RowIndex)("LuongToiThieuID").ToString
                        Dim q = (From p In data.LuongToiThieux Where p.LuongToiThieuID = intId Select p).FirstOrDefault
                        Dim huyen = (From a In data.Huyens Where a.LuongToiThieuID = intId).ToList
                        If huyen.Count = 0 Then
                            data.LuongToiThieux.DeleteObject(q)
                            data.SaveChanges()
                            intCount += 1
                        Else
                            strLTT += q.TieuDe & ";"
                        End If
                    End If
                Next
                If intCount > 0 Then
                    Excute_Javascript("Alertbox('Xóa dữ liệu thành công." & intCount.ToString & " /" & intTotal.ToString & " record. " & If(Not strLTT.Equals(""), " Các lương tối thiểu (" & strLTT & ") hiện tại có huyện tham chiếu đến", "") & "');", Me.Page, True)
                Else
                    Excute_Javascript("Alertbox('Xóa thất bại." & If(Not strLTT.Equals(""), " Các lương tối thiểu (" & strLTT & ") hiện tại có huyện tham chiếu đến", "") & "');", Me.Page, True)
                End If
            Catch ex As Exception
                log4net.Config.XmlConfigurator.Configure()
                log.Error("Error error " & AddTabSpace(1) & Session("Username") & AddTabSpace(1) & "IP:" & GetIPAddress(), ex)
                Excute_Javascript("Alertbox('Xóa thất bại (" & ex.Message & ").');", Me.Page, True)
            End Try
        End Using
        BindToGrid()
    End Sub
    Protected Sub grdShow_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles grdShow.RowDataBound
        If e.Row.RowIndex >= 0 Then
            Dim lblSTT As Label = CType(e.Row.FindControl("lblSTT"), Label)
            lblSTT.Text = CInt(drpPage_Size.SelectedValue) * (CInt(hidCur_Page.Value) - 1).ToString + e.Row.RowIndex + 1
            Dim lnkbtnDelete As LinkButton = CType(e.Row.FindControl("lnkbtnDelete"), LinkButton)
            'lnkbtnDelete.Attributes.Add("onclick", "return ComfirmDialog('" + drpMessage.Items(0).Text + "', 0,'" + lnkbtnDelete.ClientID + "','" + e.Row.RowIndex.ToString + "',1);")
            Dim hplEdit As HyperLink = CType(e.Row.FindControl("hplEdit"), HyperLink)
            hplEdit.NavigateUrl = "../../Page/LuongToiThieu/Edit.aspx?LTTID=" & grdShow.DataKeys(e.Row.RowIndex)("LuongToiThieuID").ToString
            Dim hplMota As HyperLink = CType(e.Row.FindControl("hplMota"), HyperLink)
            hplMota.NavigateUrl = "../../Page/LuongToiThieu/Detail.aspx?LTTID=" & grdShow.DataKeys(e.Row.RowIndex)("LuongToiThieuID").ToString
            hplMota.Text = grdShow.DataKeys(e.Row.RowIndex)("TieuDe").ToString
            Dim lblMucPhatMin As Label = CType(e.Row.FindControl("lblMucLuongToiThieu"), Label)
            lblMucPhatMin.Text = String.Format("{0:n0}", grdShow.DataKeys(e.Row.RowIndex)("MucLuongToiThieu"))
            Dim lblLoainhanuoc As Label = CType(e.Row.FindControl("lblLoainhanuoc"), Label)
            lblLoainhanuoc.Text = IIf(grdShow.DataKeys(e.Row.RowIndex)("IsNhaNuoc") = 1, "Nhà nước", "Ngoài nhà nước")
            Dim chkItem As CheckBox = CType(e.Row.FindControl("chkItem"), CheckBox)
            Dim hplQuanHuyen As HyperLink = CType(e.Row.FindControl("hplQuanHuyen"), HyperLink)
            Using _data As New ThanhTraLaoDongEntities
                Dim _luongtoithieu As Integer = grdShow.DataKeys(e.Row.RowIndex)("LuongToiThieuID")
                Dim k = (From q In _data.Huyens Where q.LuongToiThieuID = _luongtoithieu Select q.HuyenId).Count
                hplQuanHuyen.Text = k
                hplQuanHuyen.NavigateUrl = "../../Page/QuanHuyen/List.aspx?LuongToiThieuID=" & grdShow.DataKeys(e.Row.RowIndex)("LuongToiThieuID").ToString
                hplQuanHuyen.Target = "_blank"

            End Using
            'Permission
            hplEdit.Enabled = HasPermission(Function_Name.HanhVi, Session("RoleID"), 0, Audit_Type.Edit)
            If HasPermission(Function_Name.HanhVi, Session("RoleID"), 0, Audit_Type.Delete) = True Then
                lnkbtnDelete.Attributes.Add("onclick", "return ComfirmDialog('" + drpMessage.Items(0).Text + "', 0,'" + lnkbtnDelete.ClientID + "','" + e.Row.RowIndex.ToString + "',1);")
            Else
                lnkbtnDelete.Enabled = False
                chkItem.Enabled = False
            End If
        End If
    End Sub
#End Region
#Region "Search"
    Protected Sub btnFilter_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnFilter.Click
        BindToGrid(1, txtTitleFilter.Text.Trim())
    End Sub
#End Region

    Protected Sub btnClear_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnClear.Click
        txtTitleFilter.Text = ""
        BindToGrid(1, txtTitleFilter.Text.Trim())
    End Sub

    Protected Sub drpPage_Size_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles drpPage_Size.SelectedIndexChanged
        Dim arrSearch() As String
        arrSearch = ViewState("search")
        BindToGrid(1, arrSearch(1))
    End Sub
End Class
